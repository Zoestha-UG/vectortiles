function normalize(e){return e.trim().toLowerCase()}function createPopUp(e){new mapboxgl.Popup({closeOnClick:!0}).setLngLat(e.geometry.coordinates).setHTML("<h3>"+e.properties.name+"</h3><h4>"+e.properties.description+"</h4>").addTo(map)}function getUniqueFeatures(e,t){var a={},i=e.filter(function(e){return a[e.properties[t]]?!1:(a[e.properties[t]]=!0,!0)});return i}function buildLocationList(e){if(listings.innerHTML="",e.length)e.forEach(function(e){var t=e.properties,a=listings.appendChild(document.createElement("div"));a.className="item card",a.id=t.id;var i=a.appendChild(document.createElement("div"));i.className="card-header",i.setAttribute("role","tab"),i.setAttribute("id","heading"+a.id),i.id="heading"+a.id;var r=i.appendChild(document.createElement("h5"));r.className="mb-0";var n=r.appendChild(document.createElement("a"));n.setAttribute("data-toggle","collapse"),n.href="#collapse"+a.id,n.setAttribute("aria-expanded","false"),n.setAttribute("aria-controls","collapse"+a.id),n.className="title",n.innerHTML=t.name,n.dataPosition=a.id;var o=a.appendChild(document.createElement("div"));if(o.className="collapse",o.setAttribute("id","collapse"+a.id),o.setAttribute("role","tabpanel"),o.setAttribute("aria-labelledby","heading"+a.id),o.setAttribute("data-parent","#listings"),t.image){var s=o.appendChild(document.createElement("img"));s.className="img-responsive img-listing",s.src=t.image,s.alt=t.name,s.title=t.name}var l=o.appendChild(document.createElement("div"));l.className="card-body",l.innerHTML=t.description,l.innerHTML+="</br><a href='"+t.url+"' target='_blank' />"+t.url+"</a>",n.addEventListener("click",function(){var t=stores2.features[this.dataPosition],a=document.getElementsByClassName("mapboxgl-popup");a[0]&&a[0].parentNode.removeChild(a[0]),createPopUp(t);var i=document.getElementsByClassName("is-active");i[0]&&i[0].classList.remove("is-active"),this.classList.add("is-active")})});else{var t=document.createElement("p");t.textContent="Ziehen Sie die Karte, um die Ergebnisse zu fÃ¼llen",listings.appendChild(t),map.setFilter("locations",["has","Categories"])}}$(window).on("scroll",function(){var t=$(window).scrollTop();t>220?$(".navbar").addClass("affix"):$(".navbar").removeClass("affix")});var map=new mapboxgl.Map({container:"map",style:"https://leipzig-einkaufen.de/json/style-local.json",center:[12.3722,51.3272],zoom:11,attributionControl:!0,hash:!1}),popup=new mapboxgl.Popup({closeButton:!1}),filterEl=document.getElementById("feature-filter"),listings=document.getElementById("listings"),txtCategories=document.getElementById("txtCategories"),mapMarkers=[],stores2=function(){return stores2=null,$.ajax({async:!1,global:!1,url:"https://leipzig-einkaufen.de/location.json",dataType:"json",success:function(e){stores2=e}}),stores2}();map.on("load",function(){map.loadImage("https://leipzig-einkaufen.de/media/Marker_with_Shadow.png",function(e,t){if(e)throw e;map.addImage("marker_z",t),map.addSource("locations_source",{type:"geojson",data:stores2}),map.addLayer({id:"locations",type:"symbol",source:"locations_source",layout:{visibility:"visible","icon-image":"marker_z","icon-size":.95,"icon-allow-overlap":!0}}),map.addControl(new mapboxgl.FullscreenControl),map.on("click","locations",function(e){var t=e.features[0];createPopUp(t);var a=document.getElementsByClassName("is-active");a[0]&&a[0].classList.remove("is-active");var i=document.getElementById("heading"+t.properties.id);i&&i.classList.add("is-active");var r=document.getElementById("collapse"+t.properties.id);r&&$(r).collapse("show")}),map.on("moveend",function(){var e=map.queryRenderedFeatures({layers:["locations"]});if(e){var t=getUniqueFeatures(e,"Categories");buildLocationList(t),filterEl.value="",locations=t}}),map.on("mousemove","locations",function(){map.getCanvas().style.cursor="pointer"}),map.on("mouseleave","locations",function(){map.getCanvas().style.cursor="",popup.remove()}),$(".dropdown-item").click(function(){var e=normalize($(this).text()),t=map.querySourceFeatures("locations_source");if("alle"!==e&&(t=t.filter(function(t){var a=normalize(t.properties.name),i=normalize(t.properties.Categories);return a.indexOf(e)>-1||i.indexOf(e)>-1})),t){var a=getUniqueFeatures(t,"Categories");buildLocationList(a),map.setFilter("locations",["in","name"].concat(a.map(function(e){return e.properties.name}))),mapMarkers.forEach(function(e){e.remove()}),txtCategories.value=e}}),filterEl.addEventListener("keyup",function(e){var t=normalize(e.target.value),a=locations.filter(function(e){var a=normalize(e.properties.name),i=normalize(e.properties.Categories);return a.indexOf(t)>-1||i.indexOf(t)>-1});buildLocationList(a),map.setFilter("locations",["in","name"].concat(a.map(function(e){return e.properties.name}))),mapMarkers.forEach(function(e){e.remove()})}),buildLocationList([])})});